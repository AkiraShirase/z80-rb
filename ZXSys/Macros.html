<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module ZXSys::Macros - ruby-Z80</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
  var index_rel_prefix = "../";
</script>

<script src="../js/jquery.js"></script>
<script src="../js/darkfish.js"></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-chan_exists">#chan_exists</a>
    
    <li ><a href="#method-i-char_ptr_from_code">#char_ptr_from_code</a>
    
    <li ><a href="#method-i-create_chan_and_open">#create_chan_and_open</a>
    
    <li ><a href="#method-i-cursor_key_pressed-3F">#cursor_key_pressed?</a>
    
    <li ><a href="#method-i-find_def_fn_args">#find_def_fn_args</a>
    
    <li ><a href="#method-i-find_record">#find_record</a>
    
    <li ><a href="#method-i-key_pressed-3F">#key_pressed?</a>
    
    <li ><a href="#method-i-read_arg_string">#read_arg_string</a>
    
    <li ><a href="#method-i-read_integer_value">#read_integer_value</a>
    
    <li ><a href="#method-i-read_positive_int_value">#read_positive_int_value</a>
    
    <li ><a href="#method-i-report_error">#report_error</a>
    
    <li ><a href="#method-i-report_error_unless">#report_error_unless</a>
    
    <li ><a href="#method-i-restore_rom_interrupt_handler">#restore_rom_interrupt_handler</a>
    
    <li ><a href="#method-i-setup_custom_interrupt_handler">#setup_custom_interrupt_handler</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-ZXSys::Macros">
  <h1 id="module-ZXSys::Macros" class="module">
    module ZXSys::Macros
  </h1>

  <section class="description">
    
  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-chan_exists" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">chan_exists</span><span
            class="method-args">(name = nil, output: de, input: nil, chan_name: &#39;U&#39;, buffer: 23296)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Looks for a ZX Spectrum CHAN entry determined by <code>output</code>, <code>input</code> and a <code>chan_name</code>.</p>
<ul><li><dl class="rdoc-list note-list"><dt>output
<dd>
<p>output routine address or a 16bit register holding that address except <code>hl</code></p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>input
<dd>
<p>input routine address or a 16bit register holding that address</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>strm_no
<dd>
<p>stream number (4 - 15) or 8bit register name</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>chan_name
<dd>
<p>a channel name immediate value or a 8bit register</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>buffer
<dd>
<p>address of buffer (5 bytes) to use, by default it&#39;s a printer buffer at 23296</p>
</dd></dl>
</li></ul>

<p>Optionally give namespace label a <code>name</code>.</p>

<p>ZF=1 if found, <code>hl</code> points to the record address that matches ZF=0 if not found, <code>hl</code> points to the memory address immediately after the last record</p>

<p>Modifies: <code>af</code>, <code>hl</code>, <code>bc</code>, <code>de</code></p>
          
          

          
          <div class="method-source-code" id="chan_exists-source">
            <pre><span class="ruby-comment"># File zxlib/sys.rb, line 420</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">chan_exists</span>(<span class="ruby-identifier">name</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-value">output:</span> <span class="ruby-identifier">de</span>, <span class="ruby-value">input:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-value">chan_name:</span> <span class="ruby-string">&#39;U&#39;</span>, <span class="ruby-value">buffer:</span> <span class="ruby-value">23296</span>)
    <span class="ruby-identifier">chan_name</span> = <span class="ruby-identifier">chan_name</span>.<span class="ruby-identifier">ord</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">String</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">chan_name</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;output or input must not be hl register pair&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">output</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">input</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-identifier">name</span>, <span class="ruby-value">use:</span> [<span class="ruby-value">:rom</span>, <span class="ruby-value">:vars</span>] <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">input</span>  = <span class="ruby-identifier">rom</span>.<span class="ruby-identifier">error_j</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">input</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">output</span> = <span class="ruby-identifier">rom</span>.<span class="ruby-identifier">error_j</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">output</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">chan_name</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">chan_name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">buffer</span>
                <span class="ruby-identifier">push</span> <span class="ruby-identifier">hl</span>
        <span class="ruby-identifier">oh</span>, <span class="ruby-identifier">ol</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">output</span>)
                <span class="ruby-identifier">output</span>.<span class="ruby-identifier">split</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">output</span>
                [<span class="ruby-identifier">d</span>, <span class="ruby-identifier">e</span>]
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">ol</span>
                <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">oh</span>
                <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span>
        <span class="ruby-identifier">ih</span>, <span class="ruby-identifier">il</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">input</span>)
                <span class="ruby-identifier">input</span>.<span class="ruby-identifier">split</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">input</span>
                [<span class="ruby-identifier">d</span>, <span class="ruby-identifier">e</span>]
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">il</span>
                <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">ih</span>
                <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">de</span>            <span class="ruby-comment"># de record address</span>
                <span class="ruby-identifier">exx</span>
                <span class="ruby-identifier">push</span> <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, [<span class="ruby-identifier">prog</span>]
                <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">exx</span>                <span class="ruby-comment"># hl&#39; stop search address</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">bc</span>, <span class="ruby-value">5</span>         <span class="ruby-comment"># record length</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, [<span class="ruby-identifier">chan</span>]    <span class="ruby-comment"># CHAN</span>
                <span class="ruby-identifier">find_record</span> <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">cleanup</span>
                <span class="ruby-identifier">sbc</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">bc</span>        <span class="ruby-comment"># beginning of the record found</span>
        <span class="ruby-identifier">cleanup</span> <span class="ruby-identifier">exx</span>
                <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">exx</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-char_ptr_from_code" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">char_ptr_from_code</span><span
            class="method-args">(chars, code=a, tt:de)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Calculates the address of the first byte of a character. The calculated address will be available in the <code>hl</code> register.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>chars</code>
<dd>
<p>the address of a code=0 character as a <code>hl</code> register, address, label or a label pointer e.g.: [vars.chars].</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>code</code>
<dd>
<p>an 8-bit register or a code number (addresses and pointers works to).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>a 16-bit register except <code>hl</code>.</p>
</dd></dl>
</li></ul>

<p>Modifies: <code>af</code>, <code>tt</code>, <code>hl</code></p>
          
          

          
          <div class="method-source-code" id="char_ptr_from_code-source">
            <pre><span class="ruby-comment"># File zxlib/sys.rb, line 320</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">char_ptr_from_code</span>(<span class="ruby-identifier">chars</span>, <span class="ruby-identifier">code</span>=<span class="ruby-identifier">a</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> ((<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">chars</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">chars</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">chars</span>)) <span class="ruby-keyword">and</span>
                             <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">tt</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">tt</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">hl</span>
  <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">code</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">code</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">chars</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">chars</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>
                <span class="ruby-value">3</span>.<span class="ruby-identifier">times</span> { <span class="ruby-identifier">rlca</span> }
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">anda</span> <span class="ruby-value">0b00000111</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">th</span><span class="ruby-operator">|</span><span class="ruby-identifier">tl</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-create_chan_and_open" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_chan_and_open</span><span
            class="method-args">(name = nil, output:, input: nil, strm_no: 4, chan_name: &#39;U&#39;)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates ZX Spectrum CHAN entry and opens it as stream #N.</p>
<ul><li><dl class="rdoc-list note-list"><dt>output
<dd>
<p>output routine address or a 16bit register holding that address except <code>hl</code></p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>input
<dd>
<p>input routine address or a 16bit register holding that address</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>strm_no
<dd>
<p>stream number (4 - 15) or 8bit register name</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>chan_name
<dd>
<p>a channel name immediate value</p>
</dd></dl>
</li></ul>

<p>Optionally give namespace label a <code>name</code>.</p>

<p>Modifies: <code>af</code>, <code>hl</code>, <code>bc</code>, <code>de</code></p>
          
          

          
          <div class="method-source-code" id="create_chan_and_open-source">
            <pre><span class="ruby-comment"># File zxlib/sys.rb, line 347</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">create_chan_and_open</span>(<span class="ruby-identifier">name</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-value">output:</span>, <span class="ruby-value">input:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-value">strm_no:</span> <span class="ruby-value">4</span>, <span class="ruby-value">chan_name:</span> <span class="ruby-string">&#39;U&#39;</span>)
    <span class="ruby-identifier">chan_name</span> = <span class="ruby-constant">String</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">chan_name</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">chan_name</span>.<span class="ruby-identifier">ord</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">chan_name</span>.<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;output or input must not be the hl register&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">output</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">input</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-identifier">name</span>, <span class="ruby-value">use:</span> [<span class="ruby-value">:rom</span>, <span class="ruby-value">:vars</span>] <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">input</span>  = <span class="ruby-identifier">rom</span>.<span class="ruby-identifier">error_j</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">input</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">output</span> = <span class="ruby-identifier">rom</span>.<span class="ruby-identifier">error_j</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">output</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">strm_no</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">strm_no</span>)
            <span class="ruby-keyword">unless</span> <span class="ruby-identifier">strm_no</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">strm_no</span>   <span class="ruby-comment"># stream to open</span>
            <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># calculate the strm vector offset in hl</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">vars</span>.<span class="ruby-identifier">strms</span>.<span class="ruby-identifier">user</span> <span class="ruby-comment"># hl points to STRMS #0</span>
                <span class="ruby-identifier">adda_to</span> <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>
                <span class="ruby-identifier">push</span> <span class="ruby-identifier">hl</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">push</span> <span class="ruby-identifier">input</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">input</span>)
                <span class="ruby-identifier">push</span> <span class="ruby-identifier">output</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">output</span>)
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, [<span class="ruby-identifier">vars</span>.<span class="ruby-identifier">prog</span>]  <span class="ruby-comment"># a new channel starts below prog</span>
                <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">hl</span>          <span class="ruby-comment">#</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">bc</span>, <span class="ruby-value">0x0005</span>  <span class="ruby-comment"># make space</span>
                <span class="ruby-identifier">call</span> <span class="ruby-identifier">rom</span>.<span class="ruby-identifier">make_room</span>
                <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span>          <span class="ruby-comment"># hl points to 1st byte of new channel data</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">output</span>)
                <span class="ruby-identifier">pop</span> <span class="ruby-identifier">de</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">output</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span>
                <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">d</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">input</span>)
                <span class="ruby-identifier">pop</span> <span class="ruby-identifier">de</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">input</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">push</span> <span class="ruby-identifier">hl</span>          <span class="ruby-comment"># save address of 2nd byte of new channel data</span>
                <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span>
                <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">d</span>
                <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">chan_name</span>
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">a</span>     <span class="ruby-comment"># channel name</span>
                <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">hl</span>          <span class="ruby-comment"># get address of 2nd byte of output routine</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, [<span class="ruby-identifier">vars</span>.<span class="ruby-identifier">chans</span>] <span class="ruby-comment"># calculate the offset to the channel data</span>
                <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span>           <span class="ruby-comment"># and store it in de</span>
                <span class="ruby-identifier">sbc</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">de</span>
                <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">hl</span>      <span class="ruby-comment"># de = our channel address - chans + 1</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">strm_no</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">strm_no</span>)
                <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">hl</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">vars</span>.<span class="ruby-identifier">strms</span>.<span class="ruby-identifier">user</span>[<span class="ruby-identifier">strm_no</span>]
            <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span>      <span class="ruby-comment"># lsb of 2nd byte of new channel data</span>
                <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">d</span>      <span class="ruby-comment"># msb of 2nd byte of new channel data</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-cursor_key_pressed-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cursor_key_pressed?</span><span
            class="method-args">(t:b)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Test for cursor keys being pressed.</p>
<dl class="rdoc-list note-list"><dt><code>t</code>
<dd>
<p>a temporary register.</p>
</dd></dl>

<p>Modifies: <code>af</code>, <code>t</code>.</p>

<p>Output:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>ZF</code>=0
<dd>
<p>if any of the cursor keys is being pressed.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>a</code>
<dd>
<p>bits b0..b3=1 if a cursor key is being pressed.</p>
</dd></dl>

<pre class="ruby"> <span class="ruby-identifier">b3</span>  <span class="ruby-identifier">b2</span>  <span class="ruby-identifier">b1</span>  <span class="ruby-identifier">b0</span>
[<span class="ruby-identifier">←</span>] [<span class="ruby-identifier">↓</span>] [<span class="ruby-identifier">↑</span>] [<span class="ruby-identifier">→</span>]
</pre>
</li></ul>
          
          

          
          <div class="method-source-code" id="cursor_key_pressed-3F-source">
            <pre><span class="ruby-comment"># File zxlib/sys.rb, line 300</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">cursor_key_pressed?</span>(<span class="ruby-value">t:</span><span class="ruby-identifier">b</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
            <span class="ruby-identifier">key_pressed?</span> <span class="ruby-value">0xf7</span>, <span class="ruby-value">0x10</span> <span class="ruby-comment"># key [5]</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-identifier">key_pressed?</span> <span class="ruby-value">0xef</span>, <span class="ruby-value">0x1c</span> <span class="ruby-comment"># keys [6] [7] [8] . .</span>
            <span class="ruby-identifier">rrca</span>
            <span class="ruby-identifier">ora</span>  <span class="ruby-identifier">t</span>                  <span class="ruby-comment"># keys [5] [6] [7] [8] .</span>
            <span class="ruby-identifier">rrca</span>                    <span class="ruby-comment"># keys [←] [↓] [↑] [→]</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-find_def_fn_args" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_def_fn_args</span><span
            class="method-args">(argnum=b, subroutine:true, not_found:nil, cf_on_direct:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Get a DEF FN argument value address.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>argnum</code>
<dd>
<p>1-based argument index (0 is 256), may be a register or a number.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>subroutine</code>
<dd>
<p>if <code>true</code> will use <code>ret</code> instruction.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>not_found</code>
<dd>
<p>if <code>subroutine</code> is <code>false</code> and <code>not_found</code> is defined, the routine will jump to this address when argument was not found, otherwise success is signalled with ZF=1.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cf_on_direct</code>
<dd>
<p>if <code>true</code> and DEFADD is not defined CF will be set.</p>
</dd></dl>
</li></ul>

<p>When <code>subroutine</code> is <code>true</code> or <code>not_found</code> is <code>nil</code>, the success is signalled with <code>ZF</code>:</p>
<ul><li>
<p>ZF=1 if found,</p>
</li><li>
<p>ZF=0 if not found.</p>
</li></ul>

<p><code>hl</code> points to the argument value when found.</p>

<p>Modifies: <code>af</code>, <code>hl</code> and <code>b</code> unless <code>argnum</code> == 1</p>
          
          

          
          <div class="method-source-code" id="find_def_fn_args-source">
            <pre><span class="ruby-comment"># File zxlib/sys.rb, line 607</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">find_def_fn_args</span>(<span class="ruby-identifier">argnum</span>=<span class="ruby-identifier">b</span>, <span class="ruby-value">subroutine:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">not_found:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">cf_on_direct:</span><span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-value">use:</span> <span class="ruby-value">:vars</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">b</span>, <span class="ruby-identifier">argnum</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">argnum</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">argnum</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">hl</span>, [<span class="ruby-identifier">vars</span>.<span class="ruby-identifier">defadd</span>]
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">a</span>, <span class="ruby-identifier">h</span>
                    <span class="ruby-identifier">ora</span>   <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">scf</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cf_on_direct</span>
                    <span class="ruby-identifier">jr</span>    <span class="ruby-identifier">exit_on_zf</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">argnum</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">loop0</span>       <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">a</span>, <span class="ruby-value">5</span>              <span class="ruby-comment"># skip argument value</span>
                    <span class="ruby-identifier">adda_to</span>  <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">seek_next</span>   <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">a</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">cp</span>    <span class="ruby-value">0x0E</span>              <span class="ruby-comment"># variable argument marker</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">argnum</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
                    <span class="ruby-identifier">ret</span>   <span class="ruby-constant">Z</span>
            <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jr</span>    <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eoc</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jr</span>    <span class="ruby-constant">Z</span>, <span class="ruby-identifier">found_arg</span>
        <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">cp</span>    <span class="ruby-value">?)</span>.<span class="ruby-identifier">ord</span>            <span class="ruby-comment"># arguments terminator</span>
        <span class="ruby-identifier">exit_on_zf</span>  <span class="ruby-identifier">jr</span>    <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">seek_next</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">a</span>                 <span class="ruby-comment"># ZF=0, not found</span>
                    <span class="ruby-identifier">ret</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">not_found</span>
                    <span class="ruby-identifier">jp</span>    <span class="ruby-identifier">not_found</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">a</span>                 <span class="ruby-comment"># ZF=0, not found</span>
                    <span class="ruby-identifier">jr</span>    <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">argnum</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">argnum</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">found_arg</span>   <span class="ruby-identifier">djnz</span>  <span class="ruby-identifier">loop0</span>
                    <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-find_record" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_record</span><span
            class="method-args">(th=h, tl=l)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Search for a record that matches large block of a memory.</p>
<ul><li><dl class="rdoc-list note-list"><dt>+th|tl&#39;+
<dd>
<p>address of the last byte to search + 1 (preserved)</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>hl</code>
<dd>
<p>target</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>de</code>
<dd>
<p>source (preserved)</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>bc</code>
<dd>
<p>record length (preserved)</p>
</dd></dl>
</li></ul>

<p>ZF=1 if found, <code>hl</code> points immediately <strong>after</strong> the record that matches, CF=0 ZF=0 if not found, <code>hl</code> points to the memory address immediately after the last record</p>

<p>Modifies: <code>af</code>, <code>hl</code> and <code>stack</code></p>
          
          

          
          <div class="method-source-code" id="find_record-source">
            <pre><span class="ruby-comment"># File zxlib/sys.rb, line 478</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">find_record</span>(<span class="ruby-identifier">th</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">tl</span>=<span class="ruby-identifier">l</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">seekloop1</span>   <span class="ruby-identifier">push</span>  <span class="ruby-identifier">bc</span>
                    <span class="ruby-identifier">push</span>  <span class="ruby-identifier">de</span>
        <span class="ruby-identifier">seekloop0</span>   <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">a</span>, [<span class="ruby-identifier">de</span>]
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">cpi</span>
                    <span class="ruby-identifier">jr</span>    <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">adjust</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">a</span>, <span class="ruby-identifier">b</span>
                    <span class="ruby-identifier">ora</span>   <span class="ruby-identifier">c</span>
                    <span class="ruby-identifier">jr</span>    <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">seekloop0</span>
                    <span class="ruby-identifier">pop</span>   <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">pop</span>   <span class="ruby-identifier">bc</span>           <span class="ruby-comment"># de - preserved, bc - preserved, hl to next record after found</span>
                    <span class="ruby-identifier">jr</span>    <span class="ruby-identifier">eoc</span>          <span class="ruby-comment"># ZF=1 found</span>
        <span class="ruby-identifier">adjust</span>      <span class="ruby-identifier">add</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">bc</span>       <span class="ruby-comment"># next record</span>
                    <span class="ruby-identifier">pop</span>   <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">pop</span>   <span class="ruby-identifier">bc</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">a</span>, <span class="ruby-identifier">h</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">cp</span>    <span class="ruby-identifier">th</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">jr</span>    <span class="ruby-constant">C</span>,  <span class="ruby-identifier">seekloop1</span>  <span class="ruby-comment"># h &lt; h&#39;</span>
                    <span class="ruby-identifier">jr</span>    <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">eoc</span>    <span class="ruby-comment"># h &gt; h&#39;</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">a</span>, <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">cp</span>    <span class="ruby-identifier">tl</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">jr</span>    <span class="ruby-constant">C</span>,  <span class="ruby-identifier">seekloop1</span>  <span class="ruby-comment"># l &lt; l&#39;</span>
                    <span class="ruby-identifier">ora</span>   <span class="ruby-value">1</span>              <span class="ruby-comment"># ZF = 0</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-key_pressed-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">key_pressed?</span><span
            class="method-args">(line_mask=0, key_mask=0x1f)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Test for a key or keys being pressed.</p>
<ul><li><dl class="rdoc-list note-list"><dt>line_mask
<dd>
<p>Keyboard half-line mask, may be an 8 bit register. The default is 0 which means all available lines.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>key_mask
<dd>
<p>Key mask (b0..b4), may be an 8 bit register. The default is 0b11111 which means all keys in a half-line.</p>
</dd></dl>

<pre>      key bits                           key bits
line  b4,  b3,  b2,  b1,      b0   line  b4,  b3,  b2,   b1,      b0
0xf7 [5], [4], [3], [2],     [1]   0xef [6], [7], [8],  [9],     [0]
0xfb [T], [R], [E], [W],     [Q]   0xdf [Y], [U], [I],  [O],     [P]
0xfd [G], [F], [D], [S],     [A]   0xbf [H], [J], [K],  [L], [ENTER]
0xfe [V], [C], [X], [Z], [SHIFT]   0x7f [B], [N], [M], [SS], [SPACE]</pre>
</li></ul>

<p>Modifies: <code>af</code>.</p>

<p>Output:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>ZF</code>=0
<dd>
<p>if any of the specified keys is being pressed.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>a</code>
<dd>
<p>bits b0..b4=1 if a key is being pressed at any of the specified half-line.</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="key_pressed-3F-source">
            <pre><span class="ruby-comment"># File zxlib/sys.rb, line 275</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">key_pressed?</span>(<span class="ruby-identifier">line_mask</span>=<span class="ruby-value">0</span>, <span class="ruby-identifier">key_mask</span>=<span class="ruby-value">0x1f</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">line_mask</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
            <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
      <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">line_mask</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">line_mask</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
      <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">inp</span>  <span class="ruby-identifier">a</span>, (<span class="ruby-value">254</span>)
            <span class="ruby-identifier">cpl</span>
            <span class="ruby-identifier">anda</span> <span class="ruby-identifier">key_mask</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-read_arg_string" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">read_arg_string</span><span
            class="method-args">(adh=d, adl=e, lenh=b, lenl=c)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Read a string address and its length from a ZX Basic&#39;s stringish FP-value.</p>
<dl class="rdoc-list note-list"><dt><code>hl</code>
<dd>
<p>must point to the 1st byte of the FP-value.</p>
</dd><dt><code>adh</code>
<dd>
<p>most significant byte address output register.</p>
</dd><dt><code>adl</code>
<dd>
<p>least significant byte address output register.</p>
</dd><dt><code>lenh</code>
<dd>
<p>most significant byte length output register.</p>
</dd><dt><code>lenl</code>
<dd>
<p>least significant byte length output register.</p>
</dd></dl>

<p><code>hl</code> will point to the last byte of the FP-value.</p>

<p>Modifies: <code>hl</code>, <code>adh</code>, <code>adl</code>, <code>lenl</code>, <code>lenh</code></p>
          
          

          
          <div class="method-source-code" id="read_arg_string-source">
            <pre><span class="ruby-comment"># File zxlib/sys.rb, line 576</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">read_arg_string</span>(<span class="ruby-identifier">adh</span>=<span class="ruby-identifier">d</span>, <span class="ruby-identifier">adl</span>=<span class="ruby-identifier">e</span>, <span class="ruby-identifier">lenh</span>=<span class="ruby-identifier">b</span>, <span class="ruby-identifier">lenl</span>=<span class="ruby-identifier">c</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">if</span> [<span class="ruby-identifier">adh</span>, <span class="ruby-identifier">adl</span>, <span class="ruby-identifier">lenl</span>].<span class="ruby-identifier">any?</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">r</span>) }
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">adl</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">adh</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">lenl</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">lenh</span>, [<span class="ruby-identifier">hl</span>]
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-read_integer_value" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">read_integer_value</span><span
            class="method-args">(th=d, tl=e, sgn=c)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Read a signed integer from a ZX Basic&#39;s FP-value.</p>
<dl class="rdoc-list note-list"><dt><code>hl</code>
<dd>
<p>must point to the 1st byte of the FP-value.</p>
</dd><dt><code>th</code>
<dd>
<p>most significant byte output register.</p>
</dd><dt><code>tl</code>
<dd>
<p>least significant byte output register.</p>
</dd><dt><code>sgn</code>
<dd>
<p>sign byte register.</p>
</dd></dl>

<p>The twos complement is not being converted for a negative number.</p>

<p>Result is being loaded into <code>th</code>|<code>tl</code> and <code>sgn</code>. ZF=0 signals the FP-value is not an integer. <code>hl</code> will always point to the last byte of the FP-value.</p>

<p>Modifies: <code>af</code>, <code>hl</code>, <code>th</code>, <code>tl</code> and <code>sgn</code></p>
          
          

          
          <div class="method-source-code" id="read_integer_value-source">
            <pre><span class="ruby-comment"># File zxlib/sys.rb, line 524</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">read_integer_value</span>(<span class="ruby-identifier">th</span>=<span class="ruby-identifier">d</span>, <span class="ruby-identifier">tl</span>=<span class="ruby-identifier">e</span>, <span class="ruby-identifier">sgn</span>=<span class="ruby-identifier">c</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">if</span> [<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">tl</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sgn</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">a</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">sgn</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">tl</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">th</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ora</span>   [<span class="ruby-identifier">hl</span>]
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-read_positive_int_value" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">read_positive_int_value</span><span
            class="method-args">(th=d, tl=e)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Read a positive integer from a ZX Basic&#39;s FP-value.</p>
<dl class="rdoc-list note-list"><dt><code>hl</code>
<dd>
<p>must point to the 1st byte of the FP-value.</p>
</dd><dt><code>th</code>
<dd>
<p>most significant byte output register.</p>
</dd><dt><code>tl</code>
<dd>
<p>least significant byte output register.</p>
</dd></dl>

<p>Result is being loaded into <code>th</code>|<code>tl</code>. ZF=0 signals the FP-value is not a positive integer. <code>hl</code> will always point to the last byte of the FP-value.</p>

<p>Modifies: <code>af</code>, <code>hl</code>, <code>th</code> and <code>tl</code></p>
          
          

          
          <div class="method-source-code" id="read_positive_int_value-source">
            <pre><span class="ruby-comment"># File zxlib/sys.rb, line 550</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">read_positive_int_value</span>(<span class="ruby-identifier">th</span>=<span class="ruby-identifier">d</span>, <span class="ruby-identifier">tl</span>=<span class="ruby-identifier">e</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">if</span> [<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">tl</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">a</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ora</span>   [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">tl</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">th</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">inc</span>   <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ora</span>   [<span class="ruby-identifier">hl</span>]
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-report_error" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">report_error</span><span
            class="method-args">(error)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns to ZX <a href="../Basic.html"><code>Basic</code></a> with the error report.</p>
<ul><li><dl class="rdoc-list note-list"><dt>error
<dd>
<p>Error report signature as a number <code>0..9</code> or a letter <code>A..R</code></p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="report_error-source">
            <pre><span class="ruby-comment"># File zxlib/sys.rb, line 206</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">report_error</span>(<span class="ruby-identifier">error</span>)
    <span class="ruby-identifier">errno</span> = [<span class="ruby-operator">*</span><span class="ruby-string">&#39;0&#39;</span><span class="ruby-operator">..</span><span class="ruby-string">&#39;9&#39;</span>, <span class="ruby-operator">*</span><span class="ruby-string">&#39;A&#39;</span><span class="ruby-operator">..</span><span class="ruby-string">&#39;R&#39;</span>].<span class="ruby-identifier">index</span>(<span class="ruby-identifier">error</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">upcase</span>[<span class="ruby-value">0</span>])
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">errno</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                <span class="ruby-identifier">rst</span>  <span class="ruby-value">0x08</span>
                <span class="ruby-identifier">db</span>   <span class="ruby-identifier">errno</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-report_error_unless" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">report_error_unless</span><span
            class="method-args">(condition, error)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns to ZX <a href="../Basic.html"><code>Basic</code></a> with the error report if condition is NOT met.</p>
<ul><li><dl class="rdoc-list note-list"><dt>condition
<dd>
<p>NZ, Z, NC, C, PO, PE, P, M</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>error
<dd>
<p>Error report signature as a number <code>0..9</code> or a letter <code>A..R</code></p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="report_error_unless-source">
            <pre><span class="ruby-comment"># File zxlib/sys.rb, line 191</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">report_error_unless</span>(<span class="ruby-identifier">condition</span>, <span class="ruby-identifier">error</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">Condition</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">condition</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">condition</span>.<span class="ruby-identifier">jr_ok?</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">condition</span>, <span class="ruby-identifier">eoc</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">condition</span>, <span class="ruby-identifier">eoc</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">err</span>     <span class="ruby-identifier">report_error</span> <span class="ruby-identifier">error</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-restore_rom_interrupt_handler" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">restore_rom_interrupt_handler</span><span
            class="method-args">(enable_interrupts:true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Restore interrupt handler ZX Spectrum ROM&#39;s standard IM1 mode.</p>
<ul><li><dl class="rdoc-list note-list"><dt>enable_interrupts
<dd>
<p>If <code>true</code> invoke <code>ei</code> instruction at the end.</p>
</dd></dl>
</li></ul>

<p>Modifies: <code>a</code>, <code>i</code>.</p>
          
          

          
          <div class="method-source-code" id="restore_rom_interrupt_handler-source">
            <pre><span class="ruby-comment"># File zxlib/sys.rb, line 247</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">restore_rom_interrupt_handler</span>(<span class="ruby-value">enable_interrupts:</span><span class="ruby-keyword">true</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
            <span class="ruby-identifier">im1</span>
            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-value">0x3F</span>
            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">i</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-identifier">ei</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">enable_interrupts</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-setup_custom_interrupt_handler" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">setup_custom_interrupt_handler</span><span
            class="method-args">(handler, enable_interrupts:true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Setup custom interrupt handler using ZX Spectrum ROM&#39;s unused space as a IM2 mode jump table.</p>
<ul><li><dl class="rdoc-list note-list"><dt>handler
<dd>
<p>One of the 16bit register pair or an address or a pointer to the address of the handler routine.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>enable_interrupts
<dd>
<p>If <code>true</code> invoke <code>ei</code> instruction at the end.</p>
</dd></dl>
</li></ul>

<p>Modifies: <code>a</code>, <code>i</code>, <code>hl</code> if <code>handler</code> is not a register pair.</p>
          
          

          
          <div class="method-source-code" id="setup_custom_interrupt_handler-source">
            <pre><span class="ruby-comment"># File zxlib/sys.rb, line 222</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">setup_custom_interrupt_handler</span>(<span class="ruby-identifier">handler</span>, <span class="ruby-value">enable_interrupts:</span><span class="ruby-keyword">true</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-value">0x18</span>          <span class="ruby-comment"># 18H is jr</span>
                    <span class="ruby-identifier">ld</span>  [<span class="ruby-value">0xFFFF</span>], <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-value">0xC3</span>          <span class="ruby-comment"># C3H is jp</span>
                    <span class="ruby-identifier">ld</span>  [<span class="ruby-value">0xFFF4</span>], <span class="ruby-identifier">a</span>
        <span class="ruby-identifier">set_handler</span> <span class="ruby-identifier">label</span>                <span class="ruby-comment"># set handler part (may be used to only change the routine address)</span>
        <span class="ruby-keyword">if</span> [<span class="ruby-identifier">bc</span>, <span class="ruby-identifier">de</span>, <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">sp</span>, <span class="ruby-identifier">ix</span>, <span class="ruby-identifier">iy</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">handler</span>)
                    <span class="ruby-identifier">ld</span>  [<span class="ruby-value">0xFFF5</span>], <span class="ruby-identifier">handler</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">handler</span>
                    <span class="ruby-identifier">ld</span>  [<span class="ruby-value">0xFFF5</span>], <span class="ruby-identifier">hl</span>
        <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-value">0x39</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">i</span>, <span class="ruby-identifier">a</span>             <span class="ruby-comment"># load the accumulator with FF filled page in rom.</span>
                    <span class="ruby-identifier">im2</span>
                    <span class="ruby-identifier">ei</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">enable_interrupts</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

