<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module Z80MathInt::Macros - ruby-Z80</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
  var index_rel_prefix = "../";
</script>

<script src="../js/jquery.js"></script>
<script src="../js/darkfish.js"></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-add24_16">#add24_16</a>
    
    <li ><a href="#method-i-adda_to">#adda_to</a>
    
    <li ><a href="#method-i-bcdtoa">#bcdtoa</a>
    
    <li ><a href="#method-i-divmod16">#divmod16</a>
    
    <li ><a href="#method-i-divmod32_16">#divmod32_16</a>
    
    <li ><a href="#method-i-divmod32_8">#divmod32_8</a>
    
    <li ><a href="#method-i-divmod8">#divmod8</a>
    
    <li ><a href="#method-i-int">#int</a>
    
    <li ><a href="#method-i-mul16_32">#mul16_32</a>
    
    <li ><a href="#method-i-mul8">#mul8</a>
    
    <li ><a href="#method-i-mul8_24">#mul8_24</a>
    
    <li ><a href="#method-i-mul8_c">#mul8_c</a>
    
    <li ><a href="#method-i-mul_const8_24">#mul_const8_24</a>
    
    <li ><a href="#method-i-neg16">#neg16</a>
    
    <li ><a href="#method-i-rnd">#rnd</a>
    
    <li ><a href="#method-i-sub_from">#sub_from</a>
    
    <li ><a href="#method-i-utobcd">#utobcd</a>
    
    <li ><a href="#method-i-utobcd_step">#utobcd_step</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-Z80MathInt::Macros">
  <h1 id="module-Z80MathInt::Macros" class="module">
    module Z80MathInt::Macros
  </h1>

  <section class="description">
    
<h1 id="module-Z80MathInt::Macros-label-Z80MathInt+Macros"><a href="../Z80MathInt.html"><code>Z80MathInt</code></a> <a href="Macros.html"><code>Macros</code></a><span><a href="#module-Z80MathInt::Macros-label-Z80MathInt+Macros">&para;</a> <a href="#top">&uarr;</a></span></h1>

  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-add24_16" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">add24_16</span><span
            class="method-args">(th8=c, tl16=hl, tt=de, signed:true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Adds 16bit <code>tt</code> to 24bit <code>th8</code>|<code>tl16</code>, result in <code>a</code>|<code>tl16</code>.</p>

<p>Modifies: <code>af</code>, <code>tl16</code>.</p>

<p>T-states: 27 signed / 19 unsigned</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>th8</code>
<dd>
<p>8 bit register containing the highest 8bit of the value to be added to, must not be <code>a</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tl16</code>
<dd>
<p>16 bit register containing low 16bit of the value to be added to: <code>hl</code>, <code>ix</code>, <code>iy</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>16 bit register containing value to add: <code>bc</code>, <code>de</code> or <code>sp</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>signed</code>
<dd>
<p>should the 16 bit added value be treated as a signed integer.</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="add24_16-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 169</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">add24_16</span>(<span class="ruby-identifier">th8</span>=<span class="ruby-identifier">c</span>, <span class="ruby-identifier">tl16</span>=<span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>=<span class="ruby-identifier">de</span>, <span class="ruby-value">signed:</span><span class="ruby-keyword">true</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">tlh</span>, <span class="ruby-identifier">tll</span> = <span class="ruby-identifier">tl16</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span>[<span class="ruby-identifier">bc</span>, <span class="ruby-identifier">de</span>, <span class="ruby-identifier">sp</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">tt</span>) <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span>[<span class="ruby-identifier">hl</span>, <span class="ruby-identifier">ix</span>, <span class="ruby-identifier">iy</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">tl16</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">tlh</span>, <span class="ruby-identifier">tll</span>, <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">th8</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;add24_16 invalid arguments!&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">th</span>
            <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>
            <span class="ruby-identifier">sbc</span>  <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">add</span>  <span class="ruby-identifier">tl16</span>, <span class="ruby-identifier">tt</span>
            <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">th8</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-adda_to" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">adda_to</span><span
            class="method-args">(h, l)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Adds <code>a</code> to <code>h</code>|<code>l</code>.</p>

<p>Uses: <code>af</code>, <code>h</code>, <code>l</code>.</p>

<h4 id="method-i-adda_to-label-Note-3A">Note:<span><a href="#method-i-adda_to-label-Note-3A">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Although this method is often better (faster and does not use other registers) way to add 8bit unsigned register <code>a</code> value to 16bit register it does not set flags properly.</p>

<p>T-states: 20</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>h</code>
<dd>
<p>register input accumulator hi.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>l</code>
<dd>
<p>register input accumulator lo.</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="adda_to-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 119</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">adda_to</span>(<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>) <span class="ruby-comment"># 20</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">h</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">h</span>,<span class="ruby-identifier">l</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;adda_to invalid arguments!&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span>
            <span class="ruby-identifier">add</span>  <span class="ruby-identifier">l</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">h</span>
            <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">l</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bcdtoa" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bcdtoa</span><span
            class="method-args">(buffer, size, &amp;block)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Reads each bcd digit as <code>a</code> destroying content of a buffer in the process.</p>

<p>Uses: <code>a</code>, <code>hl</code>, <code>b</code>.</p>

<p>On first digit carry is 1 on subsequent is 0 before <code>block</code>.</p>

<p>Block must not alter <code>hl</code> or <code>b</code>.</p>
          
          

          
          <div class="method-source-code" id="bcdtoa-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 869</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bcdtoa</span>(<span class="ruby-identifier">buffer</span>, <span class="ruby-identifier">size</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Register</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">buffer</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-identifier">size</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>
                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">buffer</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">buffer</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">scf</span>
    <span class="ruby-identifier">loopa</span>       <span class="ruby-identifier">rld</span>
                <span class="ruby-identifier">ns</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
                <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">rld</span>
                <span class="ruby-identifier">ns</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
                <span class="ruby-identifier">inc</span> <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopa</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-divmod16" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">divmod16</span><span
            class="method-args">(x=ixl, check0:true, check1:true, modulo:false, quick8:true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Performs euclidean divison. Divides <code>hl</code> by <code>de</code>. Returns quotient in <code>hl</code> and remainder in <code>bc</code>. <code>de</code> remains unaltered.</p>

<p>Uses: <code>af</code>, <code>bc</code>, <code>de</code>, <code>hl</code>, <code>x</code></p>
<ul><li><dl class="rdoc-list note-list"><dt><code>x</code>
<dd>
<p>a temporary register (<code>ixh</code>, <code>ixl</code>, <code>iyh</code> or <code>iyl</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>opts
<dd></dd></dl>
<ul><li><dl class="rdoc-list note-list"><dt>:check0
<dd>
<p>(default <code>true</code>) checks if divisor is 0, in this instance CF indicates division error and nothing except <code>a</code> register is altered on CF=1. If <code>false</code> CF should be ignored.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>:check1
<dd>
<p>(default <code>true</code>) checks if divisor is 1, a hot path optimization</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>:modulo
<dd>
<p>(default <code>false</code>) calculates remainder only, in this instance <code>hl</code> will be 0 when division is finished.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>:quick8
<dd>
<p>(default <code>true</code>) checks if divisor fits in 8 bits and in this instance uses different, optimized code.</p>
</dd></dl>
</li></ul>
</li></ul>
          
          

          
          <div class="method-source-code" id="divmod16-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 505</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">divmod16</span>(<span class="ruby-identifier">x</span>=<span class="ruby-identifier">ixl</span>, <span class="ruby-value">check0:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">check1:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">modulo:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">quick8:</span><span class="ruby-keyword">true</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">ixh</span>, <span class="ruby-identifier">ixl</span>, <span class="ruby-identifier">iyh</span>, <span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">x</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">check1</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">quick8</span>
                            <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ora</span> <span class="ruby-identifier">d</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">div16strt</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">quick8</span>
                            <span class="ruby-identifier">divmod8</span> <span class="ruby-identifier">e</span>, <span class="ruby-value">check0:</span><span class="ruby-identifier">check0</span>, <span class="ruby-value">check1:</span><span class="ruby-identifier">check1</span>, <span class="ruby-value">modulo:</span><span class="ruby-identifier">modulo</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">0</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">check0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">check1</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-value">1</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-comment"># division by 0</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">div16strt</span> <span class="ruby-comment"># division by m &gt; 1</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">bc</span>, <span class="ruby-value">0</span>         <span class="ruby-comment"># clear rest</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>           <span class="ruby-comment"># division by 1</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">div16strt</span>           <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># a = 0 hi remainder</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># c = 0 lo remainder</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">16</span>
        <span class="ruby-identifier">loopfit</span>             <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># carry &lt;- hl &lt;- 0</span>
                            <span class="ruby-identifier">rl</span>  <span class="ruby-identifier">c</span>            <span class="ruby-comment"># carry &lt;- c &lt;- carry</span>
                            <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- a &lt;- carry</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">d</span>            <span class="ruby-comment"># a - d</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fitshi</span>   <span class="ruby-comment"># a &gt;= d</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit</span>     <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">ccf</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">over</span>
        <span class="ruby-identifier">fitshi</span>              <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">x</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">fitslo</span>   <span class="ruby-comment"># a &gt; d, ignore e</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">e</span>            <span class="ruby-comment"># a == d: c - e</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fitslo</span>   <span class="ruby-comment"># a &gt;= e</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">x</span> 
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit</span>     <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">ccf</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">over</span>
        <span class="ruby-identifier">fitslo</span>              <span class="ruby-identifier">sub</span> <span class="ruby-identifier">e</span>            <span class="ruby-comment"># a = c - e</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># c = c - e</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">x</span>
                            <span class="ruby-identifier">sbc</span> <span class="ruby-identifier">d</span>            <span class="ruby-comment"># a -= d</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                            <span class="ruby-identifier">inc</span> <span class="ruby-identifier">l</span>            <span class="ruby-comment"># hl &lt;- 1 (quotient)</span>
        <span class="ruby-keyword">end</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit</span>     <span class="ruby-comment"># loop</span>
        <span class="ruby-identifier">over</span>                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># bc = remainder</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-divmod32_16" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">divmod32_16</span><span
            class="method-args">(x:ixl, check0:true, check1:true, modulo:false, quick8:true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Performs euclidean divison. Divides <code>hl</code>|<code>hl&#39;</code> by <code>de</code>. Returns quotient in <code>hl</code>|<code>hl&#39;</code> and remainder in <code>bc</code>. <code>de</code> remains unaltered.</p>

<p>Uses: <code>af</code>, <code>a&#39;</code>, <code>bc</code>, <code>bc&#39;</code>, <code>de</code>, <code>de&#39;</code>, <code>hl</code>, <code>hl&#39;</code>, <code>x</code></p>
<ul><li><dl class="rdoc-list note-list"><dt><code>x</code>
<dd>
<p>a temporary register (<code>ixh</code>, <code>ixl</code>, <code>iyh</code> or <code>iyl</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>opts
<dd></dd></dl>
<ul><li><dl class="rdoc-list note-list"><dt>:check0
<dd>
<p>(default <code>true</code>) checks if divisor is 0, in this instance CF indicates division error and nothing except <code>a</code> register is altered on CF=1. If <code>false</code> CF should be ignored.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>:check1
<dd>
<p>(default <code>true</code>) checks if divisor is 1, a hot path optimization</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>:modulo
<dd>
<p>(default <code>false</code>) calculates remainder only, in this instance <code>hl</code>|<code>hl&#39;</code> will be 0 when division is finished.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>:quick8
<dd>
<p>(default <code>true</code>) checks if divisor fits in 8 bits and in this instance uses different, optimized code.</p>
</dd></dl>
</li></ul>
</li></ul>
          
          

          
          <div class="method-source-code" id="divmod32_16-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 638</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">divmod32_16</span>(<span class="ruby-value">x:</span><span class="ruby-identifier">ixl</span>, <span class="ruby-value">check0:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">check1:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">modulo:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">quick8:</span><span class="ruby-keyword">true</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">ixh</span>, <span class="ruby-identifier">ixl</span>, <span class="ruby-identifier">iyh</span>, <span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">x</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">check1</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">quick8</span>
                            <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ora</span> <span class="ruby-identifier">d</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">div32strt</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">quick8</span>
                            <span class="ruby-identifier">divmod32_8</span> <span class="ruby-identifier">e</span>, <span class="ruby-value">check0:</span><span class="ruby-identifier">check0</span>, <span class="ruby-value">check1:</span><span class="ruby-identifier">check1</span>, <span class="ruby-value">modulo:</span><span class="ruby-identifier">modulo</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">0</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">check0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">check1</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-value">1</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-comment"># division by 0</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">div32strt</span> <span class="ruby-comment"># division by m &gt; 1</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">bc</span>, <span class="ruby-value">0</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>           <span class="ruby-comment"># division by 1</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">div32strt</span>           <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># a = 0 hi remainder</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># c = 0 lo remainder</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">16</span>
        <span class="ruby-identifier">loopfit1</span>            <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># carry &lt;- hl &lt;- 0</span>
                            <span class="ruby-identifier">rl</span>  <span class="ruby-identifier">c</span>            <span class="ruby-comment"># carry &lt;- c &lt;- carry</span>
                            <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- a &lt;- carry</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">d</span>            <span class="ruby-comment"># a - d</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fitshi1</span>  <span class="ruby-comment"># a &gt;= d</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit1</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">divlo16</span>
        <span class="ruby-identifier">fitshi1</span>             <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">x</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">fitslo1</span>  <span class="ruby-comment"># a &gt; d, ignore e</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">e</span>            <span class="ruby-comment"># a == d: c - e</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fitslo1</span>  <span class="ruby-comment"># a &gt;= e</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">x</span> 
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit1</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">divlo16</span>
        <span class="ruby-identifier">fitslo1</span>             <span class="ruby-identifier">sub</span> <span class="ruby-identifier">e</span>            <span class="ruby-comment"># a = c - e</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># c = c - e</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">x</span>
                            <span class="ruby-identifier">sbc</span> <span class="ruby-identifier">d</span>            <span class="ruby-comment"># a -= d</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                            <span class="ruby-identifier">inc</span> <span class="ruby-identifier">l</span>            <span class="ruby-comment"># hl &lt;- 1 (quotient)</span>
        <span class="ruby-keyword">end</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit1</span>    <span class="ruby-comment"># loop</span>

        <span class="ruby-identifier">divlo16</span>             <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">x</span>, <span class="ruby-identifier">c</span>
                            <span class="ruby-identifier">exx</span>              <span class="ruby-comment"># hl&#39; &lt;-&gt; hl</span>
                            <span class="ruby-identifier">pop</span> <span class="ruby-identifier">de</span>           <span class="ruby-comment"># de&#39; = de</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">x</span>         <span class="ruby-comment"># c&#39; = c</span>

                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">16</span>
        <span class="ruby-identifier">loopfit2</span>            <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># carry &lt;- hl&#39; &lt;- 0</span>
                            <span class="ruby-identifier">rl</span>  <span class="ruby-identifier">c</span>            <span class="ruby-comment"># carry &lt;- c&#39; &lt;- carry</span>
                            <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- a &lt;- carry</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">fitshi2c</span>  <span class="ruby-comment"># a &gt; d</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">d</span>            <span class="ruby-comment"># a - d&#39;</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fitshi2</span>  <span class="ruby-comment"># a &gt;= d&#39;</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit2</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">ccf</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">over</span>
        <span class="ruby-identifier">fitshi2</span>             <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">x</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">fitslo2</span>  <span class="ruby-comment"># a &gt; d, ignore e</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">e</span>            <span class="ruby-comment"># a == d: c - e</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fitslo2</span>  <span class="ruby-comment"># a &gt;= e</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">x</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit2</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">ccf</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">over</span>
        <span class="ruby-identifier">fitshi2c</span>            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">x</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>
        <span class="ruby-identifier">fitslo2</span>             <span class="ruby-identifier">sub</span> <span class="ruby-identifier">e</span>            <span class="ruby-comment"># a = c&#39; - e&#39;</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># c&#39; = c&#39; - e&#39;</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">x</span>
                            <span class="ruby-identifier">sbc</span> <span class="ruby-identifier">d</span>            <span class="ruby-comment"># a -= d&#39;</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                            <span class="ruby-identifier">inc</span> <span class="ruby-identifier">l</span>            <span class="ruby-comment"># hl&#39; &lt;- 1 (quotient)</span>
        <span class="ruby-keyword">end</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit2</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">ora</span>  <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-comment"># clear carry only when check0</span>
        <span class="ruby-identifier">over</span>                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">x</span>, <span class="ruby-identifier">c</span>
                            <span class="ruby-identifier">exx</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># bc = remainder</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">x</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-divmod32_8" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">divmod32_8</span><span
            class="method-args">(m=c, check0:true, check1:true, modulo:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Performs euclidean divison. Divides <code>hl</code>|<code>hl&#39;</code> by <code>m</code>. Returns quotient in <code>hl</code>|<code>hl&#39;</code> and remainder in <code>a</code>. <code>m</code> remains unaltered.</p>

<p>Uses: <code>af</code>, <code>a&#39;</code>, <code>b</code>, <code>b&#39;</code>, <code>m</code>, <code>m&#39;</code>, <code>hl</code>, <code>hl&#39;</code></p>
<ul><li><dl class="rdoc-list note-list"><dt><code>m</code>
<dd>
<p>a divisor (<code>c</code>, <code>d</code> or <code>e</code>)</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>opts
<dd></dd></dl>
<ul><li><dl class="rdoc-list note-list"><dt>:check0
<dd>
<p>(default <code>true</code>) checks if divisor is 0, in this instance CF indicates division error and nothing except <code>a</code> register is altered on CF=1. If <code>false</code> CF should be ignored.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>:check1
<dd>
<p>(default <code>true</code>) checks if divisor is 1, a hot path optimization</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>:modulo
<dd>
<p>(default <code>false</code>) calculates remainder only, in this instance <code>hl</code>|<code>hl&#39;</code> will be 0 when division is finished.</p>
</dd></dl>
</li></ul>
</li></ul>
          
          

          
          <div class="method-source-code" id="divmod32_8-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 572</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">divmod32_8</span>(<span class="ruby-identifier">m</span>=<span class="ruby-identifier">c</span>, <span class="ruby-value">check0:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">check1:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">modulo:</span><span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">c</span>, <span class="ruby-identifier">d</span>, <span class="ruby-identifier">e</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">check1</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">m</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-value">1</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-comment"># division by 0</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">divstrt</span>  <span class="ruby-comment"># division by m &gt; 1</span>
                            <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># clear rest</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>          <span class="ruby-comment"># division by 1</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">divstrt</span>             <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># a = 0</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">16</span>
        <span class="ruby-identifier">loopfit1</span>            <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># carry &lt;- hl &lt;- 0</span>
                            <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- a &lt;- carry</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">fits1</span>     <span class="ruby-comment"># a &gt; m</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># a - m</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fits1</span>    <span class="ruby-comment"># a &gt;= m</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit1</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">divlo16</span>
        <span class="ruby-identifier">fits1</span>               <span class="ruby-identifier">sub</span> <span class="ruby-identifier">m</span>            <span class="ruby-comment"># a = a - m (rest)</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                            <span class="ruby-identifier">inc</span> <span class="ruby-identifier">l</span>            <span class="ruby-comment"># hl &lt;- 1 (quotient)</span>
        <span class="ruby-keyword">end</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit1</span>    <span class="ruby-comment"># loop</span>

        <span class="ruby-identifier">divlo16</span>             <span class="ruby-identifier">ex</span>  <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">m</span>
                            <span class="ruby-identifier">exx</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">m</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ex</span>  <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">16</span>
        <span class="ruby-identifier">loopfit2</span>            <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># carry &lt;- hl &lt;- 0</span>
                            <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- a &lt;- carry</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">fits2</span>     <span class="ruby-comment"># a &gt; m</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># a - m</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fits2</span>    <span class="ruby-comment"># a &gt;= m</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit2</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">ccf</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span>    <span class="ruby-comment"># clear carry only when check0</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">over</span>
        <span class="ruby-identifier">fits2</span>               <span class="ruby-identifier">sub</span> <span class="ruby-identifier">m</span>            <span class="ruby-comment"># a = a - m (rest)</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                            <span class="ruby-identifier">inc</span> <span class="ruby-identifier">l</span>            <span class="ruby-comment"># hl &lt;- 1 (quotient)</span>
        <span class="ruby-keyword">end</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit2</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">ora</span>  <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-comment"># clear carry only when check0</span>
        <span class="ruby-identifier">over</span>                <span class="ruby-identifier">exx</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-divmod8" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">divmod8</span><span
            class="method-args">(m=c, check0:true, check1:true, modulo:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Performs euclidean divison. Divides <code>hl</code> by <code>m</code>. Returns quotient in <code>hl</code> and remainder in <code>a</code>. <code>m</code> remains unaltered.</p>

<p>Uses: <code>af</code>, <code>b</code>, <code>m</code>, <code>hl</code></p>
<ul><li><dl class="rdoc-list note-list"><dt><code>m</code>
<dd>
<p>a divisor (<code>c</code>, <code>d</code> or <code>e</code>)</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>opts
<dd></dd></dl>
<ul><li><dl class="rdoc-list note-list"><dt>:check0
<dd>
<p>(default <code>true</code>) checks if divisor is 0, in this instance CF indicates division error and nothing except <code>a</code> register is altered on CF=1. If <code>false</code> CF should be ignored.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>:check1
<dd>
<p>(default <code>true</code>) checks if divisor is 1, a hot path optimization</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>:modulo
<dd>
<p>(default <code>false</code>) calculates remainder only, in this instance <code>hl</code> will be 0 when division is finished.</p>
</dd></dl>
</li></ul>
</li></ul>
          
          

          
          <div class="method-source-code" id="divmod8-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 455</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">divmod8</span>(<span class="ruby-identifier">m</span>=<span class="ruby-identifier">c</span>, <span class="ruby-value">check0:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">check1:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">modulo:</span><span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">c</span>, <span class="ruby-identifier">d</span>, <span class="ruby-identifier">e</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">check1</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">m</span>
                        <span class="ruby-identifier">cp</span>  <span class="ruby-value">1</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-comment"># division by 0</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">divstrt</span>  <span class="ruby-comment"># division by m &gt; 1</span>
                        <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># clear rest</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>          <span class="ruby-comment"># division by 1</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">divstrt</span>         <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># a = 0</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">16</span>
        <span class="ruby-identifier">findhi</span>          <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># align highest set bit at CF</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">found</span>
                        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">findhi</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>          <span class="ruby-comment"># hl == 0</span>
        <span class="ruby-identifier">loopfit</span>         <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># carry &lt;- hl &lt;- 0</span>
        <span class="ruby-identifier">found</span>           <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- a &lt;- carry</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">fits</span>      <span class="ruby-comment"># a &gt;= 256</span>
                        <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># a - m</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fits</span>     <span class="ruby-comment"># a &gt;= m</span>
                        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit</span>     <span class="ruby-comment"># loop</span>
                        <span class="ruby-identifier">ccf</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span>    <span class="ruby-comment"># clear carry only when check0</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>
        <span class="ruby-identifier">fits</span>            <span class="ruby-identifier">sub</span> <span class="ruby-identifier">m</span>            <span class="ruby-comment"># a = a - m (rest)</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                        <span class="ruby-identifier">inc</span> <span class="ruby-identifier">l</span>            <span class="ruby-comment"># hl &lt;- 1 (quotient)</span>
        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit</span>     <span class="ruby-comment"># loop</span>
                        <span class="ruby-identifier">ora</span>  <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-comment"># clear carry only when check0</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-int" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">int</span><span
            class="method-args">(bitsize, value)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Packs an integer of arbitrary byte size, creates a label and adds it to Program.code at Program.pc.</p>

<p>Provided <code>bitsize</code> must be a multiple of 8. Integer data is packed in LSB order.</p>
          
          

          
          <div class="method-source-code" id="int-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 62</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">int</span>(<span class="ruby-identifier">bitsize</span>, <span class="ruby-identifier">value</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;int bitsize must be &gt; 0&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">bitsize</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">bitsize</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;int bitsize must be multiple of 8&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">bitsize</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">7</span>).<span class="ruby-identifier">zero?</span>
    <span class="ruby-identifier">bytesize</span> = <span class="ruby-identifier">bitsize</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">3</span>
    <span class="ruby-identifier">klass_name</span> = <span class="ruby-node">&quot;Int#{bitsize}&quot;</span>
    <span class="ruby-identifier">int_klass</span> = <span class="ruby-keyword">if</span> <span class="ruby-constant">Z80MathInt</span><span class="ruby-operator">::</span><span class="ruby-constant">Integers</span>.<span class="ruby-identifier">const_defined?</span>(<span class="ruby-identifier">klass_name</span>)
        <span class="ruby-constant">Z80MathInt</span><span class="ruby-operator">::</span><span class="ruby-constant">Integers</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">klass_name</span>)
    <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">klass</span> = <span class="ruby-constant">Class</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Z80</span><span class="ruby-operator">::</span><span class="ruby-constant">Label</span>) <span class="ruby-keyword">do</span>
            <span class="ruby-identifier">value</span>  <span class="ruby-identifier">byte</span> <span class="ruby-identifier">bytesize</span>
            <span class="ruby-identifier">bytes</span>  <span class="ruby-identifier">value</span> <span class="ruby-identifier">byte</span>, <span class="ruby-identifier">bytesize</span>
            <span class="ruby-identifier">words</span>  <span class="ruby-identifier">value</span> <span class="ruby-identifier">word</span>, <span class="ruby-identifier">bytesize</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">zero?</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-constant">Z80MathInt</span><span class="ruby-operator">::</span><span class="ruby-constant">Integers</span>.<span class="ruby-identifier">const_set</span> <span class="ruby-identifier">klass_name</span>, <span class="ruby-identifier">klass</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">blob</span> = <span class="ruby-string">&#39;&#39;</span>
    <span class="ruby-identifier">bytesize</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
            <span class="ruby-identifier">blob</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">value</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&#39;c&#39;</span>)
            <span class="ruby-identifier">value</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">8</span>
    <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">data</span> <span class="ruby-identifier">int_klass</span>, <span class="ruby-identifier">blob</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul16_32" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul16_32</span><span
            class="method-args">(mm=bc, tt:bc)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Performs multiplication of unsigned 16bit <code>hl</code> by 16bit <code>mm</code> (<code>bc</code> or <code>de</code>) and returns result in 32 bit <code>hl</code>|<code>hl&#39;</code>.</p>

<p>Uses: <code>af</code>, <code>af&#39;</code>, <code>hl</code>, <code>hl&#39;</code>, <code>mm</code>, <code>tt&#39;</code></p>
<ul><li><dl class="rdoc-list note-list"><dt><code>mm</code>
<dd>
<p>16bit multiplicator (<code>bc</code> or <code>de</code>)</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tt&#39;</code>
<dd>
<p>16bit tempoarary register (<code>bc</code> or <code>de</code>)</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="mul16_32-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 352</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul16_32</span>(<span class="ruby-identifier">mm</span>=<span class="ruby-identifier">bc</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">bc</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">bc</span>, <span class="ruby-identifier">de</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">mm</span>) <span class="ruby-keyword">and</span> [<span class="ruby-identifier">bc</span>, <span class="ruby-identifier">de</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">tt</span>)
    <span class="ruby-identifier">mh</span>, <span class="ruby-identifier">ml</span> = <span class="ruby-identifier">mm</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">ml</span>
                        <span class="ruby-identifier">ora</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># a&#39; ?= 0</span>
                        <span class="ruby-identifier">ex</span>  <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>       <span class="ruby-comment"># a&#39; = ml, ZF&#39; = a&#39; == 0</span>
                        <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># a  = 0</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># hl&#39; = 0</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span>        <span class="ruby-comment"># th&#39;|tl&#39; = 0</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">ora</span> <span class="ruby-identifier">mh</span>           <span class="ruby-comment"># a |= mh</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">multlo0</span>   <span class="ruby-comment"># mh &lt;&gt; 0</span>

                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">mh</span>, <span class="ruby-identifier">h</span>        <span class="ruby-comment"># mh|ml = hl</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">ml</span>, <span class="ruby-identifier">l</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span>        <span class="ruby-comment"># hl = 0</span>

                        <span class="ruby-identifier">scf</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- mh &lt;- 1</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">noadd1</span>

        <span class="ruby-identifier">shadd1</span>  <span class="ruby-identifier">srl</span> <span class="ruby-identifier">mh</span>           <span class="ruby-comment"># mh -&gt; ml -&gt; th&#39;</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">ml</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">th</span><span class="ruby-operator">|</span><span class="ruby-identifier">tl</span>    <span class="ruby-comment"># hl&#39; += th&#39;|tl&#39;</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">mh</span><span class="ruby-operator">|</span><span class="ruby-identifier">ml</span>    <span class="ruby-comment"># hl  += mh|ml + carry</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- ml</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">multlo</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">shadd1</span>

        <span class="ruby-identifier">noadd1</span>  <span class="ruby-identifier">srl</span> <span class="ruby-identifier">mh</span>           <span class="ruby-comment"># mh -&gt; ml -&gt; mh&#39;</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">ml</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- ml</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">multlo</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">shadd1</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">noadd1</span>

        <span class="ruby-identifier">multlo0</span> <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">ml</span>, <span class="ruby-identifier">h</span>        <span class="ruby-comment"># mh = 0, ml = h, th&#39; = l, tl&#39; = 0</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">l</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span>        <span class="ruby-comment"># hl = 0</span>

        <span class="ruby-identifier">multlo</span>  <span class="ruby-identifier">ex</span>  <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>       <span class="ruby-comment"># a = ml, ZF = a == 0</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eoc</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- ml</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">noadd2</span>

        <span class="ruby-identifier">shadd2</span>  <span class="ruby-identifier">srl</span> <span class="ruby-identifier">ml</span>           <span class="ruby-comment"># ml -&gt; mh&#39; -&gt; ml&#39;</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">th</span><span class="ruby-operator">|</span><span class="ruby-identifier">tl</span>    <span class="ruby-comment"># hl&#39; += th&#39;|tl&#39;</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">mh</span><span class="ruby-operator">|</span><span class="ruby-identifier">ml</span>    <span class="ruby-comment"># hl  += mh|ml + carry</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- ml</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">finlo</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">shadd2</span>

        <span class="ruby-identifier">noadd2</span>  <span class="ruby-identifier">srl</span> <span class="ruby-identifier">ml</span>           <span class="ruby-comment"># ml -&gt; mh&#39; -&gt; ml&#39;</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- ml</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">finlo</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">shadd2</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">noadd2</span>

        <span class="ruby-identifier">finlo</span>   <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
                        <span class="ruby-identifier">srl</span> <span class="ruby-identifier">ml</span>           <span class="ruby-comment"># ml -&gt; mh&#39; -&gt; ml&#39;</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">th</span><span class="ruby-operator">|</span><span class="ruby-identifier">tl</span>    <span class="ruby-comment"># hl&#39; += th&#39;|tl&#39;</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">mh</span><span class="ruby-operator">|</span><span class="ruby-identifier">ml</span>    <span class="ruby-comment"># hl  += mh|ml + carry</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul8" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul8</span><span
            class="method-args">(mh=h, ml=l, m=a, tt:de, clrhl:true, double:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Performs multiplication of unsigned 16bit <code>mh</code>|<code>ml</code> * 8bit <code>m</code> and returns result in <code>hl</code>. Optionally accumulates result in <code>hl</code>. Optionally multiplies result * 2.</p>

<p>As a side-effect <code>m</code> is always cleared to 0 and <code>ml</code> and <code>mh</code> are left unmodified if they are not one of: <code>th</code> nor <code>tl</code>.</p>

<p>Uses: <code>hl</code>, <code>m</code>, <code>mh</code>, <code>ml</code>, <code>tt</code></p>
<ul><li><dl class="rdoc-list note-list"><dt><code>mh</code>
<dd>
<p>hi multiplicant immediate value or any 8bit register.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>ml</code>
<dd>
<p>lo multiplicant immediate value or any 8bit register.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>m</code>
<dd>
<p>a multiplicator register, must not be <code>tthi</code>, <code>ttlo</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>16 bit temporary register (de or bc).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>clrhl</code>
<dd>
<p>if <code>hl</code> should be set or accumulated, if <code>false</code> acts like: <code>hl</code> += <code>mh</code>|<code>ml</code> * <code>m</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>double</code>
<dd>
<p><code>true</code> if should double the result (mh|ml * 2).</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="mul8-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 235</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul8</span>(<span class="ruby-identifier">mh</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">ml</span>=<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>=<span class="ruby-identifier">a</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">clrhl:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">double:</span><span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">th</span>,<span class="ruby-identifier">tl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">tl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">mh</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ml</span> <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span><span class="ruby-identifier">m</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Register</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">ml</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ml</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">th</span>, <span class="ruby-identifier">mh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">mh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrhl</span>
                <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">muls1</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">double</span>
        <span class="ruby-identifier">loop1</span>   <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">rl</span>   <span class="ruby-identifier">th</span>
        <span class="ruby-identifier">muls1</span>   <span class="ruby-identifier">srl</span>  <span class="ruby-identifier">m</span>
                <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">noadd</span>
                <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
        <span class="ruby-identifier">noadd</span>   <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">loop1</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul8_24" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul8_24</span><span
            class="method-args">(mh=h, ml=l, m=b, t:c, tt:de, clrahl:true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Performs multiplication of unsigned 16bit <code>mh</code>|<code>ml</code> * 8bit <code>m</code> and returns result in 24bit <code>a</code>|<code>hl</code>. Optionally accumulates result in <code>a</code>|<code>hl</code>.</p>

<p>Uses: <code>af</code>, <code>bc</code>, <code>de</code>, <code>hl</code></p>
<ul><li><dl class="rdoc-list note-list"><dt><code>mh</code>
<dd>
<p>hi multiplicant immediate value or any 8bit register.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>ml</code>
<dd>
<p>lo multiplicant immediate value or any 8bit register.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>m</code>
<dd>
<p>a multiplicator register, must not be <code>a</code>, <code>tthi</code>, <code>ttlo</code> or <code>t</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>t</code>
<dd>
<p>8 bit temporary register, must not be <code>a</code>, <code>tthi</code>, <code>ttlo</code> or <code>m</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>16 bit temporary register (<code>de</code> or <code>bc</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>clrahl</code>
<dd>
<p>if <code>a</code>|<code>hl</code>  should be set or accumulated, if <code>false</code> acts like: <code>a</code>|<code>hl</code> += <code>mh</code>|<code>ml</code> * <code>m</code>.</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="mul8_24-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 263</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul8_24</span>(<span class="ruby-identifier">mh</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">ml</span>=<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>=<span class="ruby-identifier">b</span>, <span class="ruby-value">t:</span><span class="ruby-identifier">c</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">clrahl:</span><span class="ruby-keyword">true</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">a</span>,<span class="ruby-identifier">th</span>,<span class="ruby-identifier">tl</span>,<span class="ruby-identifier">t</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">a</span>,<span class="ruby-identifier">th</span>,<span class="ruby-identifier">tl</span>,<span class="ruby-identifier">m</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">t</span>) <span class="ruby-keyword">or</span>
                                                 <span class="ruby-identifier">tl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">mh</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ml</span> <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span><span class="ruby-identifier">m</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Register</span>) <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Register</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">ml</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ml</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">th</span>, <span class="ruby-identifier">mh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">mh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahl</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span>
                    <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">t</span>, <span class="ruby-value">0</span>
        <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">srl</span> <span class="ruby-identifier">m</span>           <span class="ruby-comment"># 0 -&gt; multiplicator -&gt; carry</span>
                    <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">loop1</span>   <span class="ruby-comment"># m != 0 ? start regular loop</span>
                    <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">skadd</span>    <span class="ruby-comment"># m == 1 ? add and quit</span>
                    <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>         <span class="ruby-comment"># m == 0 ? just quit</span>
        <span class="ruby-identifier">loop1</span>       <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">noadd</span>   <span class="ruby-comment"># carry == 0 ? don&#39;t add</span>
                    <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>      <span class="ruby-comment"># add multiplicant to result lo16</span>
                    <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>        <span class="ruby-comment"># add multiplicant to result hi8</span>
        <span class="ruby-identifier">noadd</span>       <span class="ruby-identifier">sla</span> <span class="ruby-identifier">tl</span>          <span class="ruby-comment"># multiplicant *= 2</span>
                    <span class="ruby-identifier">rl</span>  <span class="ruby-identifier">th</span>
                    <span class="ruby-identifier">rl</span>  <span class="ruby-identifier">t</span>
                    <span class="ruby-identifier">srl</span> <span class="ruby-identifier">m</span>           <span class="ruby-comment"># 0 -&gt; multiplicator -&gt; carry</span>
                    <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">loop1</span>   <span class="ruby-comment"># m != 0 ? loop</span>
        <span class="ruby-identifier">skadd</span>       <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>      <span class="ruby-comment"># last add b.c. carry == 1</span>
                    <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul8_c" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul8_c</span><span
            class="method-args">(mh=h, ml=l, m=a, tt:de, clrhl:true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Performs multiplication of unsigned 16bit <code>mh</code>|<code>ml</code> * 8bit <code>m</code> and returns result in <code>hl</code>. Optionally accumulates result in <code>hl</code>. Breaks on overflow with CF=1.</p>

<p>As a side-effect <code>m</code> is cleared to 0 when CF=0 and <code>ml</code> and <code>mh</code> are left unmodified if they are not one of: <code>th</code> nor <code>tl</code>.</p>

<p>Uses: <code>hl</code>, <code>m</code>, <code>mh</code>, <code>ml</code>, <code>tt</code></p>
<ul><li><dl class="rdoc-list note-list"><dt><code>mh</code>
<dd>
<p>hi multiplicant immediate value or any 8bit register.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>ml</code>
<dd>
<p>lo multiplicant immediate value or any 8bit register.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>m</code>
<dd>
<p>a multiplicator register, must not be <code>tthi</code>, <code>ttlo</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>16 bit temporary register (de or bc).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>clrhl</code>
<dd>
<p>if <code>hl</code> should be set or accumulated, if <code>false</code> acts like: <code>hl</code> += <code>mh</code>|<code>ml</code> * <code>m</code>.</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="mul8_c-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 202</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul8_c</span>(<span class="ruby-identifier">mh</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">ml</span>=<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>=<span class="ruby-identifier">a</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">clrhl:</span><span class="ruby-keyword">true</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">th</span>,<span class="ruby-identifier">tl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">tl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">mh</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ml</span> <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span><span class="ruby-identifier">m</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Register</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">ml</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ml</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">th</span>, <span class="ruby-identifier">mh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">mh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrhl</span>
        <span class="ruby-identifier">loop1</span>   <span class="ruby-identifier">srl</span> <span class="ruby-identifier">m</span>
                <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">noadd</span>
                <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span>
        <span class="ruby-identifier">noadd</span>   <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eoc</span>
        <span class="ruby-identifier">skip1</span>   <span class="ruby-identifier">sla</span> <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">rl</span>  <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop1</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul_const8_24" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul_const8_24</span><span
            class="method-args">(mh=h, ml=l, m=0, t:c, tt:de, clrahl:true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Performs multiplication of unsigned 16bit <code>mh</code>|<code>ml</code> * 8bit <code>m</code> and returns result in 24bit <code>a</code>|<code>hl</code>. Creates unrolled code so <code>m</code> should be constant in range: 0..255. Optionally accumulates result in <code>a</code>|<code>hl</code>. CF=0 ZF=1 if result fits in 16bits.</p>

<p>Uses: <code>af</code>, <code>bc</code>, <code>de</code>, <code>hl</code></p>
<ul><li><dl class="rdoc-list note-list"><dt><code>mh</code>
<dd>
<p>hi multiplicant immediate value or any 8bit register.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>ml</code>
<dd>
<p>lo multiplicant immediate value or any 8bit register.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>m</code>
<dd>
<p>an immediate 8bit multiplicator value.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>t</code>
<dd>
<p>8 bit temporary register, must not be <code>a</code>, <code>tthi</code> or <code>ttlo</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>16 bit temporary register (<code>de</code> or <code>bc</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>clrahl</code>
<dd>
<p>if <code>a</code>|<code>hl</code>  should be set or accumulated, if <code>false</code> acts like: <code>a</code>|<code>hl</code> += <code>mh</code>|<code>ml</code> * <code>m</code>.</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="mul_const8_24-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 307</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul_const8_24</span>(<span class="ruby-identifier">mh</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">ml</span>=<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>=<span class="ruby-value">0</span>, <span class="ruby-value">t:</span><span class="ruby-identifier">c</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">clrahl:</span><span class="ruby-keyword">true</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">throw</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>) <span class="ruby-keyword">and</span> (<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">255</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">and</span> [<span class="ruby-identifier">bc</span>, <span class="ruby-identifier">de</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">tt</span>) <span class="ruby-keyword">and</span>
                                                         <span class="ruby-operator">!</span>[<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">th</span>, <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">a</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">t</span>) <span class="ruby-keyword">and</span>
                                                         <span class="ruby-identifier">tl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">mh</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">ml</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">ml</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ml</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">th</span>, <span class="ruby-identifier">mh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">mh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahl</span>
                    <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">if</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">l</span>, <span class="ruby-identifier">tl</span>  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ml</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span> <span class="ruby-comment"># hl = tt * 1</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">h</span>, <span class="ruby-identifier">th</span>  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">mh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
            <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">t</span>, <span class="ruby-value">0</span>
            <span class="ruby-keyword">if</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                    <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                    <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                    <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">a</span>     <span class="ruby-comment"># CF=0 and ZF=1 in case when m == 0</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">while</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                    <span class="ruby-identifier">sla</span> <span class="ruby-identifier">tl</span>
                    <span class="ruby-identifier">rl</span>  <span class="ruby-identifier">th</span>
                    <span class="ruby-identifier">rl</span>  <span class="ruby-identifier">t</span>
            <span class="ruby-keyword">if</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                    <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                    <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>  <span class="ruby-comment"># CF=0 and ZF=1 in case when result 16 bit</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-neg16" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">neg16</span><span
            class="method-args">(h, l, th:h, tl:l)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Negates <code>h</code>, <code>l</code>.</p>

<p>Uses: <code>af</code>, <code>h</code>, <code>l</code>.</p>

<p>T-states: 24</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>h</code>
<dd>
<p>negated 16bit register hi.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>l</code>
<dd>
<p>negated 16bit register lo.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>th</code>
<dd>
<p>target register hi.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tl</code>
<dd>
<p>target register lo.</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="neg16-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 95</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">neg16</span>(<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-value">th:</span><span class="ruby-identifier">h</span>, <span class="ruby-value">tl:</span><span class="ruby-identifier">l</span>) <span class="ruby-comment"># 24</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;neg16 invalid arguments!&quot;</span> <span class="ruby-keyword">if</span> [<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">tl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">h</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
    <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span>
            <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
            <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">l</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-identifier">sbc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">h</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-rnd" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">rnd</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Lehmer random number generator.</p>

<p>See: <a href="https://en.wikipedia.org/wiki/Lehmer_random_number_generator">en.wikipedia.org/wiki/Lehmer_random_number_generator</a></p>

<p>Routine uses similar parameters as in ZX-Spectrum ROM:</p>

<pre class="ruby"><span class="ruby-identifier">s1</span> = (<span class="ruby-identifier">s0</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">75</span> <span class="ruby-operator">%</span> <span class="ruby-value">65537</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
</pre>

<p>Uses: <code>af</code>, <code>bc</code>, <code>de</code>, <code>hl</code>.</p>

<p>Expects seed in <code>hl</code> and produces next seed iteration in <code>hl</code>.</p>
          
          

          
          <div class="method-source-code" id="rnd-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 742</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">rnd</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">inc</span> <span class="ruby-identifier">hl</span>          <span class="ruby-comment"># seed + 1</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">l</span>
                        <span class="ruby-identifier">ora</span> <span class="ruby-identifier">h</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">multi75</span> <span class="ruby-comment"># (seed + 1) &lt; 65536</span>
                                        <span class="ruby-comment"># return pre-calculated value</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-value">65536</span> <span class="ruby-operator">*</span> <span class="ruby-value">75</span> <span class="ruby-operator">%</span> <span class="ruby-value">65537</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-identifier">eoc</span>
                                        <span class="ruby-comment"># overflow 0x1_0000 - 0x1_0001 = -1 happens only for seeds:</span>
                                        <span class="ruby-comment"># 65535, 20097, 34952, 40195</span>
        <span class="ruby-identifier">ovrflow</span>         <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span>           <span class="ruby-comment"># shift left (for all possible cases CF=0 after this)</span>
                                                        <span class="ruby-comment"># otherwise we should have take care of CF=1</span>
                        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">mnext</span>      <span class="ruby-comment"># this was the last iteration so the remainder result is 65536</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-identifier">eoc</span>         <span class="ruby-comment"># remainder = (borrow|hl = 0x1_0000) (seed - 1) == 65535</span>

                                        <span class="ruby-comment"># a|hl = (seed + 1) * 75</span>
        <span class="ruby-identifier">multi75</span>         <span class="ruby-identifier">mul_const8_24</span>(<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-value">75</span>, <span class="ruby-value">t:</span><span class="ruby-identifier">c</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">clrahl:</span><span class="ruby-keyword">true</span>)
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">fits</span>     <span class="ruby-comment"># a|hl &lt; 0x1_0000: n mod 65537 == n</span>
                                        <span class="ruby-comment"># a|hl never == 0x1_0000 after multiplication by 75</span>
                                        <span class="ruby-comment"># so we can ignore some checks later</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">de</span>, <span class="ruby-value">-1</span>      <span class="ruby-comment"># a|hl mod 65537 (0x1_0001) goes to borrow|hl</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">8</span>        <span class="ruby-comment"># shift left this many times before dividend fits in a divisor</span>
        <span class="ruby-identifier">mloop0</span>          <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>      <span class="ruby-comment"># pre-shift left a|hl, highest bit to CF</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">dec</span> <span class="ruby-identifier">b</span>           <span class="ruby-comment"># no check if b==0, there&#39;ll be at most 8 iterations since a &gt;= 0x01</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">mloop0</span>  <span class="ruby-comment"># CF == 0: loop</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">l</span>        <span class="ruby-comment"># swap registers: hl|a = a|hl</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">l</span>, <span class="ruby-identifier">h</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>
                        <span class="ruby-identifier">dec</span> <span class="ruby-identifier">hl</span>          <span class="ruby-comment"># hl = hl - 1, in effect: borrow|hl = 0x1_nnnn - 0x1_0001 = 0x0_mmmm</span>
                                                        <span class="ruby-comment"># no need to check for overflow here since 65536 is never a result of n*75</span>
        <span class="ruby-identifier">mloopck</span>         <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">fits</span>     <span class="ruby-comment"># b==0: (seed + 1) * 75 == 0x0001_nnnn</span>
        <span class="ruby-identifier">mloop1</span>          <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span>           <span class="ruby-comment"># shift left hl|a, highest bit to CF</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">mnext</span>   <span class="ruby-comment"># CF == 0: continue</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">de</span>      <span class="ruby-comment"># borrow|hl = 0x1_nnnn - 0x1_0001</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">ovrflow</span> <span class="ruby-comment"># 0x1_0000 - 0x1_0001 = -1 (0x1_FFFF)</span>
        <span class="ruby-identifier">mnext</span>           <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">mloop1</span>
        <span class="ruby-identifier">fits</span>            <span class="ruby-identifier">dec</span> <span class="ruby-identifier">hl</span>          <span class="ruby-comment"># seed - 1</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sub_from" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sub_from</span><span
            class="method-args">(r, h, l)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Subtracts <code>r</code> from <code>h</code>, <code>l</code>.</p>

<p>Uses: <code>af</code>, <code>r</code>, <code>h</code>, <code>l</code>, preserves <code>r</code>.</p>

<h4 id="method-i-sub_from-label-Note-3A">Note:<span><a href="#method-i-sub_from-label-Note-3A">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Although this method is often better (faster and does not use other registers) way to subtract 8bit unsigned register value from 16bit register it does not set flags properly.</p>

<p>T-states: 24</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>r</code>
<dd>
<p>register subtractor must not be <code>a</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>h</code>
<dd>
<p>register input accumulator hi.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>l</code>
<dd>
<p>register input accumulator lo.</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="sub_from-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 145</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sub_from</span>(<span class="ruby-identifier">r</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">h</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">r</span>,<span class="ruby-identifier">h</span>,<span class="ruby-identifier">l</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;sub_from invalid arguments!&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">l</span>
        <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">r</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-identifier">sbc</span>  <span class="ruby-identifier">a</span>
        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">h</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-utobcd" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">utobcd</span><span
            class="method-args">(bufend, input, size: 4, r: d, rr: de)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Converts arbitrary size unsigned integer (LSB) to bcd</p>

<p>Uses: <code>a</code>, <code>b</code>, <code>rr</code>, <code>bc&#39;</code>, <code>hl&#39;</code>, <code>r&#39;</code></p>

<p>After conversion <code>c&#39;</code> contains number of bytes used to store bcd number. Subtract it from <code>bufend</code> to get the first byte.</p>

<p>Place integer address in <code>input</code> of <code>size</code> bytes and <code>bufend</code> should point to the address immediately following buffer end. Provide large enough buffer.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>bufend</code>
<dd>
<p>must be an address (or a label)</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>input</code>
<dd>
<p>may be an immediate address (or a label) or the same as <code>rr</code>, in this instance it is expected that <code>rr&#39;</code> will already contain <code>input</code> address.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>size</code>
<dd>
<p>may be an integer or one of 8-bit registers.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>r</code>
<dd>
<p>temporary register (d or e)</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>rr&#39;</code>
<dd>
<p>temporary register (de or hl)</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="utobcd-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 834</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">utobcd</span>(<span class="ruby-identifier">bufend</span>, <span class="ruby-identifier">input</span>, <span class="ruby-value">size:</span> <span class="ruby-value">4</span>, <span class="ruby-value">r:</span> <span class="ruby-identifier">d</span>, <span class="ruby-value">rr:</span> <span class="ruby-identifier">de</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">input</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Register</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">input</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">rr</span>) <span class="ruby-keyword">and</span>
                                            (<span class="ruby-identifier">size</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>) <span class="ruby-keyword">or</span> (<span class="ruby-identifier">size</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Register</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">size</span>.<span class="ruby-identifier">bit8?</span>)) <span class="ruby-keyword">and</span>
                    [<span class="ruby-identifier">de</span>, <span class="ruby-identifier">hl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">rr</span>) <span class="ruby-keyword">and</span> [<span class="ruby-identifier">d</span>, <span class="ruby-identifier">e</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">r</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
            <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">input</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Register</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">size</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Register</span>)
                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-identifier">size</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>
                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">rr</span>, <span class="ruby-identifier">input</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">size</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">size</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>
                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">rr</span>, <span class="ruby-identifier">input</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">input</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">rr</span>
                <span class="ruby-identifier">adda_to</span> <span class="ruby-operator">*</span><span class="ruby-identifier">rr</span>.<span class="ruby-identifier">split</span>
            <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>  [<span class="ruby-identifier">bufend</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>], <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">exx</span>
                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-value">1</span>
                <span class="ruby-identifier">exx</span>
    <span class="ruby-identifier">loopi</span>       <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">rr</span>
                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, [<span class="ruby-identifier">rr</span>]
                <span class="ruby-identifier">exx</span>
                <span class="ruby-identifier">utobcd_step</span>(<span class="ruby-identifier">bufend</span>, <span class="ruby-identifier">r</span>, <span class="ruby-identifier">c</span>, <span class="ruby-identifier">c</span>, <span class="ruby-keyword">true</span>)
                <span class="ruby-identifier">exx</span>
                <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopi</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-utobcd_step" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">utobcd_step</span><span
            class="method-args">(bufend, r, buflen=1, t=c, r_in_a=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Convert a 8-bit unsigned integer to bcd allows for arbitrary integer size conversion.</p>

<p>Used by <code>utobcd</code>.</p>

<p>Uses: <code>a</code>, <code>b</code>, <code>r</code>, <code>t</code>, <code>hl</code></p>
          
          

          
          <div class="method-source-code" id="utobcd_step-source">
            <pre><span class="ruby-comment"># File z80/math_i.rb, line 792</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">utobcd_step</span>(<span class="ruby-identifier">bufend</span>, <span class="ruby-identifier">r</span>, <span class="ruby-identifier">buflen</span>=<span class="ruby-value">1</span>, <span class="ruby-identifier">t</span>=<span class="ruby-identifier">c</span>, <span class="ruby-identifier">r_in_a</span>=<span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">c</span>, <span class="ruby-identifier">d</span>, <span class="ruby-identifier">e</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">r</span>) <span class="ruby-keyword">and</span> [<span class="ruby-identifier">c</span>, <span class="ruby-identifier">d</span>, <span class="ruby-identifier">e</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">t</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">t</span> <span class="ruby-keyword">and</span>
                    (<span class="ruby-operator">!</span><span class="ruby-identifier">buflen</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Register</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">buflen</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">t</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">r</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">r_in_a</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">t</span>, <span class="ruby-identifier">buflen</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">buflen</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">t</span>
                        <span class="ruby-identifier">scf</span>
                        <span class="ruby-identifier">rla</span>              <span class="ruby-comment"># carry &lt;- a &lt;- 1</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">r</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-identifier">buffmul</span>         <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">bufend</span><span class="ruby-value">-1</span> <span class="ruby-comment"># multiply buffer[] * 2 + carry using BCD</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-identifier">t</span>
        <span class="ruby-identifier">nextadd</span>         <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, [<span class="ruby-identifier">hl</span>]
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">daa</span>
                        <span class="ruby-identifier">ld</span>  [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">dec</span> <span class="ruby-identifier">hl</span>
                        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">nextadd</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">nbufext</span>  <span class="ruby-comment"># no carry</span>
                        <span class="ruby-identifier">inc</span> <span class="ruby-identifier">t</span>            <span class="ruby-comment"># extend buffer on carry</span>
                        <span class="ruby-identifier">inc</span> <span class="ruby-identifier">b</span>            <span class="ruby-comment"># b = 1</span>
                        <span class="ruby-identifier">ld</span>  [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">b</span>      <span class="ruby-comment"># put 1 in new place</span>
        <span class="ruby-identifier">nbufext</span>         <span class="ruby-identifier">sla</span> <span class="ruby-identifier">r</span>            <span class="ruby-comment"># carry &lt;- r &lt;- 0</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">buffmul</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

